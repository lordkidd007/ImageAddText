<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>图片加文字</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style type="text/css">
			#list {
				/*避免导航边框和列表背景边框重叠，看起来像两条边框似得；*/
				margin-top: -1px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<label>水印内容</label>
			<textarea name="message" rows="10" cols="30" id="Value"></textarea>
			<div class="mui-input-group">

				<div class="mui-input-row">
					<label>字号</label>
					<div class="mui-numbox">
						<!-- "-"按钮，点击可减小当前数值 -->
						<button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
						<input class="mui-numbox-input" type="number" id="Size" value="20"/>
						<!-- "+"按钮，点击可增大当前数值 -->
						<button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
					</div>
				</div>
				<div class="mui-input-row">
					<label>图片</label>
					<input type="file" class="mui-input-clear" id="imageInput" accept="image/*">
				</div>
				<div class="mui-button-row">
					<label>颜色</label>
					<!-- <button type="button" >蓝色</button> -->
					<input class="mui-btn mui-btn-primary" type="color" id="Color" value="#ff0000" />
				</div>
				<div class="mui-button-row">
					<span> </span>
				</div>
				<div class="mui-button-row">
					<button type="button" class="mui-btn mui-btn-primary" id="sub">生成</button>
					<!-- <button type="button" class="mui-btn mui-btn-danger">取消</button> -->
				</div>
			</div>


			<canvas id="preview" hidden></canvas> <!-- 隐藏canvas，直接使用img显示，但处理在canvas中进行 -->
			<img id="finalPreview" src="" alt="Preview with Watermark">



		</div>

		<script src="js/mui.min.js"></script>
		<script src="js/update.js" type="text/javascript" charset="utf-8"></script>
		<script>
			var textarea = document.getElementById('Value');
			var placeholder = '在这里输入水印内容...';

			// 初始时显示占位符  
			textarea.value = placeholder;

			// 当textarea获得焦点时  
			textarea.onfocus = function() {
				if (textarea.value === placeholder) {
					textarea.value = '';
					textarea.style.color = ''; // 如果有的话，移除占位符的特定样式  
				}
			};

			// 当textarea失去焦点且为空时  
			textarea.onblur = function() {
				if (textarea.value === '') {
					textarea.value = placeholder;
					textarea.style.color = '#aaa'; // 可以为占位符添加特定样式  
				}
			};




			document.getElementById('sub').addEventListener('click', function(event) {
				console.log("2");
				const file = document.getElementById('imageInput').files[0];
				if (!file.type.startsWith('image/')) {
					alert('请上传图片文件！');
					return;
				}
				console.log("8");
				let strShuiYin = document.getElementById('Value').value;
				let strZihao = document.getElementById('Size').value;
				let strYanse = document.getElementById('Color').value;
				// let strx = document.getElementById('posX').value;
				// let stry = document.getElementById('posY').value;
				let x = 10;
				let y = parseInt(strZihao);
				console.log(strShuiYin, strYanse, strZihao);

				const reader = new FileReader();
				reader.onload = function(e) {
					const img = new Image();
					img.onload = function() {
						const canvas = document.getElementById('preview');
						const ctx = canvas.getContext('2d');

						// 设置canvas的尺寸与图片相同  
						canvas.width = img.width;
						canvas.height = img.height;

						// 清除canvas（虽然这里是首次绘制，但清除是个好习惯）  
						ctx.clearRect(0, 0, canvas.width, canvas.height);

						// 绘制图片  
						ctx.drawImage(img, 0, 0);

						// 添加水印  
						ctx.font = strZihao + 'px 微软雅黑 bold';
						ctx.fillStyle = strYanse; //'rgba(255, 255, 255, 0.5)'; // 半透明  
						var lines = strShuiYin.split('\n');

						lines.forEach(function(line) {
							ctx.fillText(line, 10, y); // 假设从x=10开始绘制每行文本  
							y += parseInt(strZihao); // 根据需要调整每行之间的间距  
						});

						// 将canvas的内容设置为img的src  
						document.getElementById('finalPreview').src = canvas.toDataURL();
						alert("123");
						// 如果需要，可以取消canvas的隐藏状态，但在这里我们直接用img显示  
						// canvas.hidden = false;  
					};
					img.src = e.target.result;
				};
				reader.readAsDataURL(file);
			});
		</script>
	</body>

</html>